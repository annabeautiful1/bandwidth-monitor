# 📡 Bandwidth Monitor v2.1.0 发版说明

## 🚀 主要新功能

### 🔥 时区热更新支持
- **无需重启**：支持系统时区变更的热重载，避免服务重启带来的上线/下线通知打扰
- **多系统兼容**：支持Debian/Ubuntu (`/etc/timezone`) 和 RedHat/CentOS (`/etc/localtime`) 两种时区检测方式
- **智能检测**：每5秒自动检测系统时区变更，实时应用到日志时间戳和阈值计算
- **线程安全**：使用读写锁确保时区切换的并发安全性

### 💻 CPU和内存监控告警
- **智能阈值**：默认95%的CPU和内存使用率告警阈值
- **Telegram通知**：支持CPU/内存异常和恢复的Telegram机器人通知
- **状态管理**：防重复告警机制，只在状态变化时发送通知
- **可视化标识**：使用不同emoji图标区分告警类型（🔥 CPU，💾 内存，🚨 带宽，📴 离线）

### ⚙️ 配置文件自动升级
- **无缝升级**：程序启动时自动检测并添加缺失的配置项
- **默认值填充**：自动为新功能添加合理的默认值（CPU/内存阈值95%）
- **向后兼容**：保持与旧配置文件的完全兼容性
- **格式统一**：确保所有客户端配置文件格式和内容的一致性

## 🔧 重要优化

### 📊 带宽检测逻辑改进
- **瓶颈检测**：改为取上下行带宽的**最小值**进行异常检测
- **更准确的判断**：如下行200Mbps上行500Mbps时，以200Mbps为判断基准
- **真实反映**：更好地反映网络性能的实际瓶颈情况

### 🛠️ 配置管理重构  
- **自动应用默认值**：配置加载时自动检测和保存缺失的默认配置项
- **简化代码逻辑**：移除冗余的升级函数，统一配置处理流程
- **实时保存**：配置更新后立即保存到磁盘，确保持久化

### 🧹 代码质量提升
- **清理废弃代码**：移除不再使用的UpgradeServerConfig/UpgradeClientConfig函数
- **修复编译错误**：补充缺失的import导入
- **日志管理确认**：确认systemd journalctl的自动日志清理机制完善

## 🌟 用户体验改进

### 📱 一键控制脚本 (bmctl.sh)
- **智能镜像选择**：自动检测网络环境，国内用户使用ghfast.top加速镜像
- **时区设置优化**：设置时区后支持热重载，无需手动重启服务
- **快捷命令增强**：`sudo bm`, `status bm`, `log bm`, `sudo restart bm`

### 📦 安装脚本改进
- **环境变量支持**：支持通过环境变量预设CPU/内存告警阈值
- **交互式配置**：新增CPU和内存阈值的交互式设置（默认95%）
- **镜像加速**：支持RELEASE_MIRROR环境变量指定下载镜像

## 📋 配置文件变更

### 服务端配置新增字段
```json
{
  "thresholds": {
    "cpu_percent": 95.0,      // CPU告警阈值（新增）
    "memory_percent": 95.0    // 内存告警阈值（新增）
  }
}
```

### 客户端配置优化
- 自动升级2时段到3时段动态阈值配置
- 确保所有必要的配置项都有默认值

## 🛡️ 稳定性增强

### 🔄 热重载机制
- **配置热重载**：客户端每5秒检查配置文件变更，无需重启
- **时区热重载**：系统时区变更自动检测和应用
- **网卡配置热重载**：网卡设置变更时自动重置统计缓存

### 🔒 线程安全保障
- **时区管理**：使用sync.RWMutex确保时区读写的线程安全
- **配置访问**：配置读写操作全部加锁保护
- **状态管理**：告警状态变更的原子性保障

## 📊 监控能力提升

### 📈 多维度监控
- **网络带宽**：支持上下行分别监控，取最小值判断异常
- **系统资源**：CPU使用率和内存占用率实时监控
- **服务状态**：节点在线/离线状态跟踪
- **时间精度**：时区感知的精确时间戳记录

### 🔔 通知系统完善
- **多种告警类型**：带宽、CPU、内存、离线四类告警
- **恢复通知**：资源使用率恢复正常时的自动通知
- **状态去重**：避免重复告警的智能状态机制

## 🚧 升级指引

### 自动升级（推荐）
```bash
# 使用bmctl.sh一键升级
sudo bash <(curl -sSL https://raw.githubusercontent.com/annabeautiful1/bandwidth-monitor/main/scripts/bmctl.sh)
```

### 手动升级
```bash
# 服务端升级
curl -sSL https://raw.githubusercontent.com/annabeautiful1/bandwidth-monitor/main/scripts/install-server.sh | bash

# 客户端升级  
curl -sSL https://raw.githubusercontent.com/annabeautiful1/bandwidth-monitor/main/scripts/install-client.sh | bash
```

### 配置兼容性
- ✅ **无需手动修改**：程序启动时自动升级配置文件
- ✅ **保留用户设置**：现有配置项保持不变，仅添加新的默认值
- ✅ **格式统一**：确保所有配置文件格式的一致性

---

## 🔄 相比上一版本的完整变更清单

### 新增功能 (🆕)
- ✅ 时区热更新支持，无需重启服务
- ✅ CPU使用率告警（默认95%阈值）
- ✅ 内存使用率告警（默认95%阈值）
- ✅ 配置文件自动升级机制
- ✅ Telegram多类型告警通知
- ✅ 网络环境自动检测和镜像选择

### 重要修复 (🐛)
- 🔧 修复时区设置后日志时间戳不更新的问题
- 🔧 修复阈值计算使用错误时区的问题
- 🔧 修复带宽检测逻辑（改为取最小值）
- 🔧 修复配置文件格式不统一的问题

### 性能优化 (⚡)
- 🚀 配置热重载机制，减少服务重启需求
- 🚀 智能状态管理，避免重复告警
- 🚀 线程安全的时区和配置管理
- 🚀 代码简化，移除废弃函数

### 用户体验 (💫)
- 🎯 一键脚本智能镜像选择
- 🎯 配置文件自动补全默认值
- 🎯 交互式配置向导优化
- 🎯 快捷命令系统增强

---

**下载地址**：[GitHub Releases](https://github.com/annabeautiful1/bandwidth-monitor/releases/latest)

**完整文档**：[项目README](https://github.com/annabeautiful1/bandwidth-monitor/blob/main/README.md)

**问题反馈**：[GitHub Issues](https://github.com/annabeautiful1/bandwidth-monitor/issues)